steps:
- name: 'gcr.io/cloud-builders/git'
  secretEnv: [ 'SSH_KEY' ]
  entrypoint: 'bash'
  args:
      - -c
      - |
        echo "$$SSH_KEY" >> /root/.ssh/id_rsa
        chmod 400 /root/.ssh/id_rsa
        cp known_hosts.github /root/.ssh/known_hosts
  volumes:
  - name: 'ssh'
    path: /root/.ssh
# We will clone our repository
- name: "gcr.io/cloud-builders/git"
  args: ["clone","git@github.com:kamesh1231/backend.git"]
  volumes:
  - name: 'ssh'
    path: /root/.ssh

# Build the image
- name: "gcr.io/cloud-builders/docker"
  args: ["build","-t","gcr.io/on-the-money/backend:latest","."]

# Push the image
- name: "gcr.io/cloud-builders/docker"
  args: ["push","gcr.io/on-the-money/backend:latest"]

# Deploy container image to cloud run
- name: "gcr.io/cloud-builders/gcloud"
  args: ["run","deploy","backend","--image","gcr.io/on-the-money/backend:latest","--region","australia-southeast1","--allow-unauthenticated"]

images:
- "gcr.io/on-the-money/backend:latest"

availableSecrets:
  secretManager:
  - versionName: projects/on-the-money/secrets/github-key/versions/latest
    env: 'SSH_KEY'